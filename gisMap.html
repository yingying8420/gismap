<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Gis地图查询</title>
  <link rel="stylesheet" href="./css/index.css">
  <link rel="stylesheet" href="./css/animate.css">
  <link rel="stylesheet" href="./css/gismap.css">
  <!-- <link rel="stylesheet" href="./arcgis_js_api/library/4.11/esri/themes/light/main.css" /> -->

  <!-- 引入样式 -->

  <style>
    html,
    body,
    #app {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      background: rgb(0, 95, 150);
    }

    /* #topbar {
      background: #fff;
      padding: 10px;
    } */

    /* .action-button {
      font-size: 16px;
      background-color: transparent;
      border: 1px solid #d3d3d3;
      color: #6e6e6e;
      height: 32px;
      width: 32px;
      text-align: center;
      box-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
    } */

    /* .action-button:hover,
    .action-button:focus {
      background: #636363;
      color: #e4e4e4;
    } */

    /* .active {
      background: #636363;
      color: #e4e4e4;
    } */
  </style>
  <script src="./js/vue.js"></script>
  <script src="./js/index.js"></script>
  <script src="./js/axios.min.js"></script>
  <!-- <script src="./arcgis_js_api/library/4.11/init.js"></script> -->

  <!-- <script>
    var doQuery;
    var doGl;
    require([
      "esri/Map",
      "src/TiandiImageLayer",
      "src/TiandiImageAnnoLayer",
      "esri/views/SceneView",
      "esri/layers/MapImageLayer",
      "esri/layers/IntegratedMeshLayer",
      "esri/layers/GraphicsLayer",
      "esri/tasks/QueryTask",
      "esri/tasks/support/Query",
      "esri/widgets/DirectLineMeasurement3D",
      "esri/widgets/AreaMeasurement3D"
    ], function (
      Map, TiandiImageLayer, TiandiImageAnnoLayer, SceneView, MapImageLayer, IntegratedMeshLayer, GraphicsLayer,
      QueryTask, Query, DirectLineMeasurement3D, AreaMeasurement3D
    ) {
      var queryResult = {};
      //新建影像图层
      var TiandiImageLayer = new TiandiImageLayer();
      //新建标注图层
      var TiandiImageAnnoLayer = new TiandiImageAnnoLayer();

      var layer = new MapImageLayer({
        url: "https://gis.gwpdi.com:6443/arcgis/rest/services/Plan/BG_Service/MapServer"
      });

      /*permitsLayer，这个是这个链接：https://gis.gwpdi.com:6443/arcgis/rest/services/BaiGuan_TestTif/MapServer即那个项目区带状底图影像*/
      var permitsLayer = new MapImageLayer({
        url: "https://gis.gwpdi.com:6443/arcgis/rest/services/BaiGuan_TestTif/MapServer"
      });
      /*meshlayer，这个是这个链接：https://gis.gwpdi.com:6443/arcgis/rest/services/Hosted/fuba/SceneServer就是那个无人机三维模型*/
      var meshlayer = new IntegratedMeshLayer({
        url: "https://gis.gwpdi.com:6443/arcgis/rest/services/Hosted/fuba/SceneServer"
      });

      var activeWidget = null;

      var resultsLayer = new GraphicsLayer();

      var map = new Map({
        layers: [TiandiImageLayer, TiandiImageAnnoLayer, permitsLayer, layer, meshlayer, resultsLayer],
        ground: "world-elevation"
      });

      var view = new SceneView({
        container: "app",
        map: map,
        center: [106.539749, 23.923348],
        zoom: 14,
        popup: {
          dockEnabled: true,
          dockOptions: {
            position: "top-right",
            breakpoint: false
          }
        }
      });

      // add the toolbar for the measurement widgets
      view.ui.add("topbar", "top-right");
      view.ui.move(['zoom', 'navigation-toggle', 'compass'], 'bottom-right');

      view.when(function () {
        view.ui.add("optionsDiv", "bottom-left");
        document.getElementById("doGlBtn").addEventListener("click", doGl);
      });

      var peaksUrl_DLTB =
        "https://gis.gwpdi.com:6443/arcgis/rest/services/Plan/BG_Service/MapServer/14";
      var peaksUrl_FW =
        "https://gis.gwpdi.com:6443/arcgis/rest/services/Plan/BG_Service/MapServer/12";
      var peaksUrl_FS_D =
        "https://gis.gwpdi.com:6443/arcgis/rest/services/Plan/BG_Service/MapServer/0";
      var peaksUrl_FS_X =
        "https://gis.gwpdi.com:6443/arcgis/rest/services/Plan/BG_Service/MapServer/3";
      var qTask;

      var params = new Query({
        returnGeometry: true,
        outFields: ["*"]
      });

      var highlightSelect;
      /*
        单击一条数据高亮
        glCode:点击数据的mapCode
      */
      doGl = function (glCode) {
        if (highlightSelect) {
          highlightSelect.remove();
        }

        // the feature to be highlighted
        var feature = queryResult[glCode];

        // use the objectID to highlight the feature
        view.whenLayerView(resultsLayer).then(function (layerView) {
          highlightSelect = layerView.highlight(
            feature
          );
        });

        // center the feature
        view.goTo({
          target: feature.geometry,
        });
      }

      /*
        地图查询方法
        fType:tab页签类型td(土地),fw(房屋),fs(附属)
        sType:附属类型category字段,
        queryStr:地图查询CODE集合，字符串'A','B','C'
      */
      doQuery = function (fType, sType, queryStr) {
        // Clear the results from a previous query
        resultsLayer.removeAll();
        queryResult = {};
        if (fType == "td") {
          doQueryExt(peaksUrl_DLTB, queryStr);
        } else if (fType == "fw") {
          doQueryExt(peaksUrl_FW, queryStr);
        } else {
          doQueryExt(peaksUrl_FW, queryStr);
          doQueryExt(peaksUrl_FS_X, queryStr);
          doQueryExt(peaksUrl_FS_D, queryStr);
        }
      }

      function doQueryExt(peaksUrl, queryStr) {
        qTask = new QueryTask({
          url: peaksUrl
        });

        params.where = "CODE IN (" + queryStr + ")";
        // executes the query and calls getResults() once the promise is resolved
        // promiseRejected() is called if the promise is rejected
        qTask.execute(params)
          .then(getResults)
          .catch(promiseRejected);
      }

      var peakResults;
      // Called each time the promise is resolved
      function getResults(response) {

        // Loop through each of the results and assign a symbol and PopupTemplate
        // to each so they may be visualized on the map

        peakResults = response.features.map(function (feature) {
          feature.symbol = {
            type: "simple-fill", // autocasts as new PointSymbol3D()
            color: "#00FCFC",
            outline: {
              color: [128, 128, 128, 0.5],
              width: "0.5px"
            }
          };
          queryResult[feature.attributes.CODE] = feature;
          //feature.popupTemplate = popupTemplate;
          return feature;
        });

        resultsLayer.addMany(peakResults);
        view.goTo(peakResults).then(function () {
          /**view.popup.open({
            features: peakResults,
            featureMenuOpen: true,
            updateLocationEnabled: true
          });**/

        });

        // print the number of results returned to the user
        // document.getElementById("printResults").innerHTML = "查询到" + peakResults.length +
        //   "个记录！";
      }

      // Called each time the promise is rejected
      function promiseRejected(error) {
        console.error("错误信息: ", error.message);
      }

      document
        .getElementById("distanceButton")
        .addEventListener("click", function () {
          setActiveWidget(null);
          if (!this.classList.contains("active")) {
            setActiveWidget("distance");
          } else {
            setActiveButton(null);
          }
        });

      document
        .getElementById("areaButton")
        .addEventListener("click", function () {
          setActiveWidget(null);
          if (!this.classList.contains("active")) {
            setActiveWidget("area");
          } else {
            setActiveButton(null);
          }
        });

      function setActiveWidget(type) {
        switch (type) {
          case "distance":
            activeWidget = new DirectLineMeasurement3D({
              view: view
            });

            // skip the initial 'new measurement' button
            activeWidget.viewModel.newMeasurement();

            view.ui.add(activeWidget, "top-right");
            setActiveButton(document.getElementById("distanceButton"));
            break;
          case "area":
            activeWidget = new AreaMeasurement3D({
              view: view
            });

            // skip the initial 'new measurement' button
            activeWidget.viewModel.newMeasurement();

            view.ui.add(activeWidget, "top-right");
            setActiveButton(document.getElementById("areaButton"));
            break;
          case null:
            if (activeWidget) {
              view.ui.remove(activeWidget);
              activeWidget.destroy();
              activeWidget = null;
            }
            break;
        }
      }

      function setActiveButton(selectedButton) {
        // focus the view to activate keyboard shortcuts for sketching
        view.focus();
        var elements = document.getElementsByClassName("active");
        for (var i = 0; i < elements.length; i++) {
          elements[i].classList.remove("active");
        }
        if (selectedButton) {
          selectedButton.classList.add("active");
        }
      }

      view.on("click", function (evt) {
        console.log(Vue.prototype);
        view.hitTest(evt).then(function (response) {
          var result = response.results[0];
          console.log(evt);
          console.log(response);
          // debugger
          if (result && result.graphic) {
            var graphic = result.graphic;
            doGl(graphic.attributes.CODE);
          }
        })
      });
    });
  </script> -->
</head>

<body>
  <div id="app">
    <!-- 测距工具栏  -->
    <div id="topbar">
      <button class="action-button esri-icon-minus" id="distanceButton" type="button"
        title="Measure distance between two points"></button>
      <button class="action-button esri-icon-polygon" id="areaButton" type="button" title="Measure area"></button>
    </div>

    <!-- 查询按钮 -->
    <transition name="hide-button" enter-active-class="animated fadeInLeft faster"
      leave-active-class="animated fadeOutLeft faster">
      <el-button type="primary" size="mini" type="primary" @click="handleChangeBtn" class="change-button"
        v-if="showButton" icon="el-icon-search">条件筛选</el-button>
    </transition>

    <!-- 左边栏 -->
    <transition name="custom-classes-transition" enter-active-class="animated fadeInLeft faster"
      leave-active-class="animated fadeOutLeft faster">
      <div class="left-slider" v-if="showSlider" ref="thisLeft">
        <div class="left-slider-top">
          <el-button icon="el-icon-back" size="mini" circle type="primary" class="back-to-hide" title="收起"
            @click="handleHideBtn"></el-button>
        </div>
        <!-- 表单查询 -->
        <span class="form-title">Gis地图查询</span>
        <el-form :model="gisSearchData" ref="gisSearchData" label-width="80px" size="mini">
          <el-form-item label="实物分类" prop="thingsType">
            <el-select v-model="gisSearchData.thingsType" placeholder="请选择实物分类" style="width: 250px;">
              <el-option label="农村" value="village"></el-option>
            </el-select>
          </el-form-item>

          <el-form-item label="所属区域" prop="areaId">
            <el-select v-model="gisSearchData.areaName" placeholder="请选择所属区域" style="width: 250px;">
              <el-option :value="gisSearchData.areaId" style="padding: 0;overflow: auto;height: 200px;">
                <el-tree id="tree" ref="tree" :data="treeData" :props="treeProps" node-key="id"
                  :expand-on-click-node="false" @node-click="treenodeclick">
                </el-tree>
              </el-option>
            </el-select>
          </el-form-item>

          <el-form-item label="是否计划" prop="isPlanAct">
            <el-select v-model="gisSearchData.isPlanAct" style="width: 250px;" @change="handleChangePlan">
              <el-option label="请选择" value=""></el-option>
              <el-option label="计划" value="1"></el-option>
              <el-option label="实际" value="0"></el-option>
            </el-select>
          </el-form-item>

          <el-form-item label="产权人" prop="ownerId" v-if="ownerShow">
            <el-input v-model="gisSearchData.ownerId" placeholder="请填写产权人" size="mini" style="width: 250px;"></el-input>
          </el-form-item>

          <el-form-item label="征地状态" prop="processStatus">
            <el-checkbox-group v-model="gisSearchData.processStatus" @change="checkProcess">
              <el-checkbox label="0" value="0" style="margin-right: 15px;">未征</el-checkbox>
              <el-checkbox label="1" value="1" style="margin-right: 15px;">已征</el-checkbox>
              <el-checkbox label="4" value="4" style="margin-right: 15px;">还地</el-checkbox>
              <el-checkbox label="5" value="5" style="margin-right: 15px;">异常</el-checkbox>
            </el-checkbox-group>
          </el-form-item>

          <el-form-item>
            <el-button type="primary" @click="searchForm('gisSearchData')" size="mini">查 询</el-button>
            <el-button @click="resetForm('gisSearchData')" size="mini">重 置</el-button>
          </el-form-item>
        </el-form>
      </div>
    </transition>


  </div>
  <script src="./js/main.js"></script>
</body>

</html>